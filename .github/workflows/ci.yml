# CI: validate dbt project and Airflow DAGs on every PR and push to main
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  dbt:
    name: dbt deps & parse
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dbt
        run: |
          pip install dbt-core dbt-dremio

      - name: dbt deps
        working-directory: dbt
        run: dbt deps

      - name: dbt parse
        working-directory: dbt
        run: dbt parse

  airflow-dags:
    name: Airflow DAGs check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Airflow
        run: |
          pip install "apache-airflow==2.8.2" "apache-airflow-providers-mysql" --constraint "https://raw.githubusercontent.com/apache/airflow/constraints-2.8.2/constraints-3.11.txt"

      - name: Validate DAGs
        env:
          AIRFLOW_HOME: ${{ github.workspace }}/airflow_ci
          AIRFLOW__CORE__LOAD_EXAMPLES: "false"
        run: |
          mkdir -p airflow_ci/dags
          cp -r airflow/dags/* airflow_ci/dags/
          python -c "
          from airflow.models import DagBag
          bag = DagBag(dag_folder='airflow_ci/dags', include_examples=False)
          if bag.import_errors:
              raise SystemExit('DAG import errors: ' + str(bag.import_errors))
          print('DAGs OK:', list(bag.dag_ids))
          "

  yaml-lint:
    name: YAML lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Check YAML syntax
        run: |
          pip install pyyaml --quiet
          python -c "
          import yaml
          for p in ['dbt/dbt_project.yml', 'dbt/profiles.yml', 'dbt/models/sources.yml',
                    'dbt/models/bronze/schema.yml', 'dbt/models/silver/schema.yml', 'dbt/models/gold/schema.yml']:
              with open(p) as f:
                  yaml.safe_load(f)
              print(p, 'OK')
          "
