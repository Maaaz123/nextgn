# Data stack: MinIO + Apache Iceberg + Dremio + Airflow (no Postgres)
# Warehouse = MinIO + Dremio + Iceberg. Airflow metadata = SQLite. Metabase = H2.
# Usage: docker compose up -d

services:
  minio:
    image: minio/minio:latest
    container_name: data_tools_minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    networks:
      - data_tools_network

  dbt:
    build:
      context: .
      dockerfile: Dockerfile.dbt
    image: data-tools-dbt
    container_name: data_tools_dbt
    volumes:
      - ./dbt:/dbt
    networks:
      - data_tools_network

  dremio:
    image: dremio/dremio-oss:latest
    container_name: data_tools_dremio
    environment:
      DREMIO_JAVA_SERVER_EXTRA_OPTS: "-Dpaths.dist=file:///opt/dremio/data -Ddist.path=file:///opt/dremio/data"
    volumes:
      - dremio_data:/opt/dremio/data
    ports:
      - "9047:9047"
      - "31010:31010"
      - "45678:45678"
    depends_on:
      - minio
    networks:
      - data_tools_network

  airflow-webserver:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    container_name: data_tools_airflow_webserver
    command: webserver
    volumes:
      - airflow_metadata:/opt/airflow/metadata
      - ./dbt:/opt/airflow/dbt
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/logs:/opt/airflow/logs
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      AIRFLOW__CORE__EXECUTOR: SequentialExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: sqlite:////opt/airflow/metadata/airflow.db
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__CORE__FERNET_KEY: ""
      AIRFLOW__CORE__ENABLE_IMPLICIT_ALLOW: "true"
      AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "true"
      _AIRFLOW_WWW_USER_USERNAME: ${AIRFLOW_USERNAME:-admin}
      _AIRFLOW_WWW_USER_PASSWORD: ${AIRFLOW_PASSWORD:-admin}
      DBT_PROJECT_HOST_PATH: ${DBT_PROJECT_HOST_PATH}
    ports:
      - "8080:8080"
    depends_on:
      airflow-init:
        condition: service_completed_successfully
    networks:
      - data_tools_network

  airflow-scheduler:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    container_name: data_tools_airflow_scheduler
    command: scheduler
    volumes:
      - airflow_metadata:/opt/airflow/metadata
      - ./dbt:/opt/airflow/dbt
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/logs:/opt/airflow/logs
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      AIRFLOW__CORE__EXECUTOR: SequentialExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: sqlite:////opt/airflow/metadata/airflow.db
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__CORE__FERNET_KEY: ""
      AIRFLOW__CORE__ENABLE_IMPLICIT_ALLOW: "true"
      DBT_PROJECT_HOST_PATH: ${DBT_PROJECT_HOST_PATH}
    depends_on:
      airflow-init:
        condition: service_completed_successfully
    networks:
      - data_tools_network

  airflow-init:
    build:
      context: .
      dockerfile: Dockerfile.airflow
    container_name: data_tools_airflow_init
    user: root
    command: >
      bash -c "
        mkdir -p /opt/airflow/metadata &&
        chown -R 50000:0 /opt/airflow/metadata &&
        su airflow -s /bin/bash -c 'airflow db init' &&
        su airflow -s /bin/bash -c \"airflow users create --username ${AIRFLOW_USERNAME:-admin} --password ${AIRFLOW_PASSWORD:-admin} --firstname Admin --lastname User --role Admin --email admin@localhost || true\"
      "
    environment:
      AIRFLOW__CORE__EXECUTOR: SequentialExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: sqlite:////opt/airflow/metadata/airflow.db
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      AIRFLOW__CORE__FERNET_KEY: ""
      AIRFLOW__CORE__ENABLE_IMPLICIT_ALLOW: "true"
    volumes:
      - airflow_metadata:/opt/airflow/metadata
      - ./airflow/logs:/opt/airflow/logs
    networks:
      - data_tools_network

  mysql:
    image: mysql:8.0
    container_name: data_tools_mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-mysql}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-mydb}
      MYSQL_USER: ${MYSQL_USER:-mysql}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-mysql}
    ports:
      - "3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-pmysql"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - data_tools_network

  metabase:
    build:
      context: .
      dockerfile: Dockerfile.metabase
    image: data-tools-metabase:v0.51-dremio
    pull_policy: never  # Use only our built image (v0.51.14 + Dremio); never pull metabase:latest
    container_name: data_tools_metabase
    environment:
      MB_DB_TYPE: h2
      MB_DB_FILE: /metabase-data/metabase.db
      MB_PLUGINS_DIR: /plugins
    volumes:
      - metabase_data:/metabase-data
    ports:
      - "3000:3000"
    networks:
      - data_tools_network

volumes:
  minio_data:
  dremio_data:
  airflow_metadata:
  metabase_data:

networks:
  data_tools_network:
    driver: bridge
