#cloud-config
package_update: true
packages:
  - docker.io
  - docker-compose-plugin
  - git

runcmd:
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker root
  - |
    if [ -n "${repo_url}" ]; then
      git clone -b "${repo_branch}" "${repo_url}" /opt/app 2>/dev/null || true
      if [ -d /opt/app ]; then
        echo "POSTGRES_PASSWORD=${postgres_password}" > /opt/app/.env
        echo "AIRFLOW_PASSWORD=${airflow_password}" >> /opt/app/.env
        echo "DBT_PROJECT_HOST_PATH=/opt/app/dbt" >> /opt/app/.env
        cd /opt/app && docker compose up -d || true
      fi
    fi
